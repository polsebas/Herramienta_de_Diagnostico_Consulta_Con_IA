# Progress Report â€“ Herramienta de DiagnÃ³stico y Consulta con IA

Este documento registra el estado actual del proyecto, los objetivos de mejora con **ingenierÃ­a de contexto**, y el plan de implementaciÃ³n en fases para convertir la herramienta en un sistema escalable y robusto de diagnÃ³stico y consulta.

---

## ğŸ” Estado Actual (agosto 2025)

- **Stack**:  
  - Python 3.11+  
  - Milvus Lite (vector DB)  
  - SentenceTransformers (`all-MiniLM-L6-v2`)  
  - Async Agents (con flags `use_tools`, `show_tool_calls`)  

- **Funcionalidad actual**:  
  - Procesamiento automÃ¡tico de `.md` en `knowledge_base/`  
  - IndexaciÃ³n en Milvus  
  - RAG bÃ¡sico: recuperaciÃ³n semÃ¡ntica + respuesta LLM  
  - Uso tÃ­pico: consultas tÃ©cnicas ("Â¿CÃ³mo funciona el sistema de pagos?")  

- **Limitaciones**:  
  - Sin contratos/specs â†’ riesgo de respuestas vagas  
  - Contexto crece sin control â†’ alucinaciones en multi-turno  
  - RecuperaciÃ³n solo vectorial, sin rerank ni filtros  
  - Sin subagentes (todo centralizado en `Agent`)  
  - Sin evaluaciÃ³n automatizada de calidad ni mÃ©tricas  

---

## ğŸš€ Objetivo â€œNext Levelâ€

Aplicar el workflow **Research â†’ Plan â†’ Implement**, con:

1. **Spec-first development**  
   - Cada query se transforma en un contrato de tarea (objetivos, restricciones, formato).  
2. **CompactaciÃ³n intencional**  
   - Resumir historial y chunks â†’ <40% de la ventana del modelo.  
3. **Subagentes especializados**  
   - Retrieval, Analysis, Synthesis, Verification.  
4. **RecuperaciÃ³n avanzada**  
   - HÃ­brido BM25 + vector + rerank, con metadatos enriquecidos.  
5. **Guardrails**  
   - Citas obligatorias, suposiciones explÃ­citas, checklist de formato.  
6. **EvaluaciÃ³n continua**  
   - Golden set de queries, compliance con contrato, recall, latencia, tokens.  
7. **Entrega prÃ¡ctica**  
   - CLI (`ragc`) y API (FastAPI).  

---

## ğŸ“‚ Nueva OrganizaciÃ³n del Repo

app/
â”œâ”€ spec_layer.py
â”œâ”€ context_manager.py
â”œâ”€ subagents/
â”‚ â”œâ”€ retrieval.py
â”‚ â”œâ”€ analysis.py
â”‚ â”œâ”€ synthesis.py
â”‚ â””â”€ verification.py
â”œâ”€ retrieval/
â”‚ â”œâ”€ splitters.py
â”‚ â”œâ”€ hybrid.py
â”‚ â”œâ”€ rerank.py
â”‚ â””â”€ store_milvus.py
â”œâ”€ prompts/
â”‚ â”œâ”€ retrieval.md
â”‚ â”œâ”€ analyze.md
â”‚ â”œâ”€ synthesis.md
â”‚ â””â”€ verification.md
â”œâ”€ eval/
â”‚ â”œâ”€ evaluate_contract_compliance.py
â”‚ â”œâ”€ measure_token_usage.py
â”‚ â””â”€ benchmark_retrieval.py
â”œâ”€ api/server.py
â””â”€ cli.py
docs/
â”œâ”€ CONTRATOS.md
â””â”€ PLAYBOOKS.md
tests/
logs/
â””â”€ context_stats.jsonl


---

## ğŸ“Œ Roadmap de PRs

### PR-1 â†’ Spec-first Layer
- [ ] Crear `app/spec_layer.py` con `TaskContract`  
- [ ] Hook en `Agent` para generar contrato antes de responder  
- [ ] Documentar en `docs/CONTRATOS.md`  

### PR-2 â†’ CompactaciÃ³n
- [ ] Implementar `app/context_manager.py` (resumen de historial y chunks)  
- [ ] Logging de tokens (usar `tiktoken`)  
- [ ] Guardar en `logs/context_stats.jsonl`  

### PR-3 â†’ RecuperaciÃ³n avanzada
- [ ] `retrieval/hybrid.py`: merge vector + BM25  
- [ ] `rerank.py`: usar modelo re-ranker local (`bge-reranker-base`)  
- [ ] `splitters.py`: chunking semÃ¡ntico (por tÃ­tulos Markdown)  
- [ ] `store_milvus.py`: esquema con metadatos (doc_id, title, section, line_start/end, updated_at)  

### PR-4 â†’ Subagentes
- [ ] `subagents/retrieval.py`: bÃºsqueda hÃ­brida  
- [ ] `subagents/analysis.py`: clusterizaciÃ³n, detecciÃ³n de huecos  
- [ ] `subagents/synthesis.py`: redacciÃ³n segÃºn contrato  
- [ ] `subagents/verification.py`: checklist de cumplimiento  

### PR-5 â†’ EvaluaciÃ³n
- [ ] Crear `eval/` con golden set de 20â€“40 queries reales  
- [ ] Script `evaluate_contract_compliance.py` â†’ compliance %  
- [ ] Script `benchmark_retrieval.py` â†’ Recall@k, nDCG@k  
- [ ] Script `measure_token_usage.py` â†’ reducciÃ³n promedio  

### PR-6 â†’ CLI + API
- [ ] CLI `ragc`:  
  - `ragc ask "..." --format md`  
  - `ragc index ./knowledge_base`  
- [ ] FastAPI con endpoints `/ask`, `/health`, `/metrics`  

---

## ğŸ“Š MÃ©tricas de Progreso

| MÃ©trica                 | Baseline | Meta Next Level |
|--------------------------|----------|-----------------|
| **Contract compliance** | ~40â€“50% | â‰¥80% |
| **Tokens por prompt**   | 100%    | âˆ’30% |
| **Recall@5**            | ~60%    | +20% |
| **Latencia p95**        | 1.0x    | âˆ’20% |
| **Alucinaciones**       | Alta    | âˆ’50% |

---

## âœ… Estado de Avances

- [x] RAG inicial con Milvus Lite + embeddings.  
- [ ] Spec layer (contratos YAML/Markdown).  
- [ ] CompactaciÃ³n de contexto.  
- [ ] Subagentes modulares.  
- [ ] RecuperaciÃ³n hÃ­brida con rerank.  
- [ ] EvaluaciÃ³n continua (golden set).  
- [ ] CLI + FastAPI.  

---

## ğŸ”® PrÃ³ximos pasos inmediatos

1. Implementar **PR-1 (spec_layer.py)**.  
2. Correr baseline: 20 queries â†’ medir precisiÃ³n, tokens y longitud de respuestas.  
3. Documentar contratos de ejemplo en `docs/CONTRATOS.md`.  

---
